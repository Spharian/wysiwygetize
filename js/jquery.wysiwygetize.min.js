jQuery.fn.wysiwygetize=function(e){function k(){window.getSelection?v=window.getSelection():document.selection.createRange&&(v=document.selection.createRange())}function L(){h&&setTimeout(function(){k();T.show();if(v.getRangeAt)var e=v.getRangeAt(0).getClientRects()[0];else var e=v.getClientRects()[0];if(e){var t=e.left,n=e.bottom;T.css({top:n+10,left:t})}if(v.text)var r=!0;!v.getRangeAt(0).collapsed||r?T.show():T.hide()})}function A(){$(".styled-output").each(function(){var e=$(this),t=e.prev();e.css({width:t.outerWidth(),height:t.outerHeight(),top:0,left:0})})}function O(){var e=$("[data-wysigetize-item="+g+"]"),n=F.find("textarea").val(),r=F.find(".styled-output").html();e.find("textarea").val(n);e.find(".styled-output").html(r);E?$(".viewsource-btn").addClass(t.viewsource.activeClass):$(".viewsource-btn").removeClass(t.viewsource.activeClass);F.stop(!1,!0).fadeOut(function(){F.empty();$(".wysigetize-textarea-wrapper").removeClass("fullscreen");$("body, html").animate({scrollTop:m},200)});$("html, body").removeClass("no-wy-scroll")}function M(e){v.anchorNode.parentNode.localName===e?document.execCommand("formatBlock",!1,"<p>"):document.execCommand("formatBlock",!1,"<"+e+">");T.hide()}var t=$.extend({buttons:{bold:"B",italic:"I",underline:"U",link:"Link",h1:"H1",h2:"H2",h3:"H3"},viewsource:{display:!0,label:"View source","class":"viewsource-style",activeClass:"active-btn"},fullscreen:{display:!0,label:"Fullscreen",exitLabel:"Quit fullscreen","class":"fullscreen-style"},style:"dark"},e),n=$("body"),r=$('<ul class="buttons-list"></ul>'),i=$(".buttons-list button"),s=0;switch(t.style){case"dark":var o="#383838",u="#272626",a="#fff";break;case"light":var o="#F7F7F7",u="#E1E1E1",a="#252525"}$("html").addClass("wysiwygetize");n.append(r);n.append('<div id="fullscreen-container"></div>');r.css({background:u,borderRadius:"3px",overflow:"hidden",margin:0,padding:0,listStyle:"none",display:"none",position:"fixed",zIndex:20,border:"1px solid #272626"});$.each(t.buttons,function(e,t){s++;var n=1;s===1&&(n=0);var i=$('<button data-tag="'+e+'">'+t+"</button>");i.css({background:o,border:"none",color:a,cursor:"pointer",fontFamily:"Arial, sans-serif",fontSize:"17px",margin:0,outline:"none",display:"block",padding:"13px 20px"});switch(e){case"bold":i.css("font-weight","bold");break;case"italic":i.css("font-style","italic");break;case"underline":i.css("text-decoration","underline")}r.append('<li style="float: left; margin: 0 0 0 '+n+'px">'+i[0].outerHTML+"</li>")});i.hover(function(){$(this).css("background",u)},function(){i.css("background",o)});var f=this,l,c,h=!1,p,d,v,m,g,y=0,b=!1,w=!0,E=!1,S=$(document),x=$(window),T=$(".buttons-list"),N=$(".buttons-list button"),C="";s=0;f.each(function(){var e=$(this);y++;e.css({outline:"none",resize:"none"});s++;e.wrap('<div class="wysigetize-textarea-wrapper" data-wysigetize-item="'+s+'">');t.viewsource.display&&t.fullscreen.display?e.after('<ul class="wysigetize-controls" style="top: -'+e.css("margin-bottom")+'"><li class="fullscreen-btn '+t.fullscreen.class+'">'+t.fullscreen.label+'</li><li class="viewsource-btn '+t.viewsource.class+'">'+t.viewsource.label+"</li></ul>"):t.viewsource.display?e.after('<ul class="wysigetize-controls" style="top: -'+e.css("margin-bottom")+'"><li class="viewsource '+t.viewsource.class+'">'+t.viewsource.label+"</li></ul>"):t.fullscreen.display&&e.after('<ul class="wysigetize-controls" style="top: -'+e.css("margin-bottom")+'"><li class="fullscreen '+t.fullscreen.class+'">'+t.fullscreen.label+"</li></ul>");e.after($('<div class="styled-output" contenteditable="true" tabindex="'+y+'">').css({backgroundColor:e.css("background-color"),borderRadius:e.css("border-radius"),position:"absolute",top:0,left:0,border:e.css("border"),width:e.outerWidth(),height:e.outerHeight(),boxShadow:e.css("box-shadow"),marginTop:e.css("margin-top"),marginLeft:e.css("margin-left"),padding:e.css("padding-top"),fontFamily:e.css("font-family"),fontSize:e.css("font-size"),lineHeight:e.css("line-height"),outline:"none",overflowX:"hidden",borderColor:e.css("border-top-color"),borderWidth:e.css("border-top-width"),border:e.css("border-top-width")+" solid "+e.css("border-top-color"),wordWrap:"break-word"}))});var _=$(".wysigetize-textarea-wrapper");_.width(_.find("textarea").outerWidth());S.on("keyup",".styled-output",function(){var e=$(this);e.prev().val(e.html())});S.on("focus",".styled-output",function(){h=!0;var e=$(this);if(b)if(document.body.createTextRange){var t=document.body.createTextRange();t.moveToElementText(element);t.select();b=!1}else if(window.getSelection){var n=window.getSelection(),t=document.createRange();t.selectNodeContents(e[0]);n.removeAllRanges();n.addRange(t);b=!1}});S.on("blur",".styled-output",function(){var e=$(this);h=!1;c=e.first();l=e.first().prev();if(w){e.css(P);T.hide()}});$(".styled-output").each(function(){var e=$(this);e.html(e.prev().text())});var D=["border-top-width","border-top-color","border-right-color","border-bottom-color","border-left-color","box-shadow","color","font-family","font-size","background-color"],P=f.css(D),H=$(".styled-output").eq(0).prev().focus().css(D);$(".styled-output").eq(0).prev().blur();$(".styled-output").focus(function(){$(this).css(H)});S.mouseup(function(){L()});S.keyup(function(){v&&L()});S.click(function(){setTimeout(function(){A()})});S.keydown(function(e){e.which===27&&O()});x.keydown(function(e){e.which===9&&(b=!0)});x.resize(function(){A()});x.scroll(function(){if(v&&v.rangeCount!==0){var e=v.getRangeAt(0).getClientRects()[0];if(e){var t=e.left,n=e.bottom;T.css({top:n+10,left:t})}}});$(".styled-output").scroll(function(){T.hide()});S.on("mousedown",".buttons-list button[data-tag]",function(){w=!1});S.on("mouseup",".buttons-list button[data-tag]",function(){w=!0});S.on("click",".buttons-list button[data-tag]",function(){$(c).focus();switch($(this).data("tag")){case"bold":document.execCommand("bold",!1,null);break;case"italic":document.execCommand("italic",!1,null);break;case"underline":document.execCommand("underline",!1,null);break;case"link":var e=prompt("Specify a link");e&&document.execCommand("createLink",!1,e);break;case"h1":M("h1");break;case"h2":M("h2");break;case"h3":M("h3")}var t=$(c).html();$(l).val(t)});var B=$("body"),j,F=$("#fullscreen-container"),I=$(".fullscreen-btn"),q=I.eq(0).text();S.on("click",".viewsource-btn",function(){var e=$(this),n=e.parents(".wysigetize-textarea-wrapper").find(".styled-output");e.toggleClass(t.viewsource.activeClass);n.toggle();E=!E;$(".styled-output").each(function(){var e=$(this);e.html(e.prev().val())})});S.on("click",".fullscreen-btn",function(){if(F.children().length===0){m=S.scrollTop();var e=$(this).parents(".wysigetize-textarea-wrapper"),n=e.find("textarea").val();j=e.clone();g=j.data("wysigetize-item");F.append(j);F.fadeIn(function(){$("html, body").addClass("no-wy-scroll")});j.addClass("fullscreen").removeAttr("data-wysigetize-item");j.find(".fullscreen-btn").text(t.fullscreen.exitLabel);j.find("textarea").val(n)}else O()})};